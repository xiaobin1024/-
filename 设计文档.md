@startuml
skinparam groupInheritance 2
skinparam nodesep 10
skinparam ranksep 10

' 核心接口定义
interface IMessageHandler {

+ canHandle(MsgType): bool
+ handleMessage(Msg): void
+ messageProcessed(Msg)
+ errorOccurred(QString)
  }

interface INetworkManager {

+ connectToServer(QString, int): bool
+ disconnectFromServer(): void
+ sendMessage(Msg): void
+ connectionStateChanged(bool)
+ messageReceived(Msg)
  }

' 工厂类
class MessageHandlerFactory {

- m_handlers: QMap<MsgType, IMessageHandler*>
+ instance(): MessageHandlerFactory&
+ registerHandler(MsgType, IMessageHandler*): void
+ createHandler(MsgType): QSharedPointer<IMessageHandler>
  }

class ConfigFactory {

- m_rootConfig: QJsonObject
+ instance(): ConfigFactory&
+ loadConfig(QString): void
+ getConfig(QString, QVariant): QVariant
  }

' 配置管理类
class PageConfigManager {

- m_pagesById: QMap<int, PageConfig>
- m_pagesByName: QMap<QString, PageConfig>
- m_styles: QMap<QString, QMap<QString, QString>>
+ instance(): PageConfigManager&
+ loadConfig(QString): void
+ getPageConfig(int): PageConfig
+ registerPage(PageConfig): void
  }

struct PageConfig {

- pageId: int
- pageName: QString
- layoutType: QString
- widgetConfigs: QMap<QString, QVariant>
- styleConfigs: QMap<QString, QVariant>
  }

' 页面管理类
class PageManager {

- m_stackedWidget: QStackedWidget*
- m_pages: QMap<int, BasePage*>
- m_pageHistory: QList<int>
+ registerPage(int, BasePage*): void
+ switchToPage(int): void
+ currentPage(): BasePage*
+ pageChanged(int, int)
  }

' 基础页面类
abstract class BasePage {

 m_config: PageConfig

m_pageId: int

m_mainLayout: QVBoxLayout*

m_widgets: QMap<QString, QWidget*>

initializePage(): void

createWidgets(): void

setupLayout(): void

applyStyles(): void

setupConnections(): void
}

' 具体页面类
class MainMenuPage {

- m_titleLabel: QLabel*
- m_registerBtn: QPushButton*
- m_loginBtn: QPushButton*
- m_quitBtn: QPushButton*
+ onRegisterClicked(): void
+ onLoginClicked(): void
+ onQuitClicked(): void
  }

class LoginPage {

- m_usernameEdit: QLineEdit*
- m_passwordEdit: QLineEdit*
- m_tipLabel: QLabel*
+ onLoginConfirm(): void
+ onLoginBack(): void
  }

class QueryPage {

- m_queryEdit: QLineEdit*
- m_meaningTextEdit: QTextBrowser*
- m_collectBtn: QPushButton*
+ onQueryConfirm(): void
+ onCollectClicked(): void
+ onPlaySound(): void
  }

' 消息处理器类
class LoginHandler {

- m_networkManager: INetworkManager*
+ canHandle(MsgType): bool
+ handleMessage(Msg): void
- processLogin(Msg): void
- validateCredentials(QString, QString): void
  }

class RegisterHandler {

+ canHandle(MsgType): bool
+ handleMessage(Msg): void
- validateRegistration(QString, QString): void
  }

class QueryHandler {

+ canHandle(MsgType): bool
+ handleMessage(Msg): void
- processQueryResult(Msg): void
  }

' 网络管理类
class NetworkManager {

- m_socket: QTcpSocket*
- m_heartbeatTimer: QTimer*
- m_reconnectTimer: QTimer*
- m_serverIp: QString
- m_serverPort: int
+ connectToServer(QString, int): bool
+ sendBusinessMessage(Msg, MsgType, QObject*, const char*): void
+ onReadyRead(): void
  }

' 主窗口类
class MainWindow {

- m_pageManager: PageManager*
- m_networkManager: INetworkManager*
- m_stackedWidget: QStackedWidget*
- m_statusLabel: QLabel*
+ initializeNetwork(): void
+ initializePages(): void
+ onMessageReceived(Msg): void
+ onPageChanged(int, int): void
  }

' 消息结构体
struct Msg {

- type: MsgType
- name: char[20]
- text: char[1280]
+ networkByteOrder(): void
+ hostByteOrder(): void
  }

enum MsgType {
  REGISTER
  LOGIN
  QUIT
  SEARCH
  HISTORY
  HEARTBEAT
  COLLECT
  QUERYCOLLECT
}

' 依赖关系
MainWindow --> PageManager
MainWindow --> INetworkManager
MainWindow --> QStackedWidget

PageManager --> BasePage
PageManager --> QStackedWidget

BasePage <|-- MainMenuPage
BasePage <|-- LoginPage
BasePage <|-- QueryPage

IMessageHandler <|.. LoginHandler
IMessageHandler <|.. RegisterHandler
IMessageHandler <|.. QueryHandler

MessageHandlerFactory --> IMessageHandler
MessageHandlerFactory ..> MsgType

ConfigFactory ..> PageConfigManager
PageConfigManager --> PageConfig

NetworkManager ..|> INetworkManager
NetworkManager --> QTcpSocket
NetworkManager --> QTimer

MainWindow --> ConfigFactory
BasePage --> PageConfigManager
LoginHandler --> NetworkManager

MsgType --> Msg

' 信号槽关系
MainWindow ..> PageManager : 管理
MainWindow ..> INetworkManager : 使用
PageManager ..> BasePage : 包含
MessageHandlerFactory ..> IMessageHandler : 创建实例

' 分组显示
package "界面层" {
  MainWindow
  PageManager
  BasePage
  MainMenuPage
  LoginPage
  QueryPage
}

package "业务逻辑层" {
  IMessageHandler
  LoginHandler
  RegisterHandler
  QueryHandler
  MessageHandlerFactory
}

package "网络层" {
  INetworkManager
  NetworkManager
  Msg
  MsgType
}

package "配置层" {
  ConfigFactory
  PageConfigManager
  PageConfig
}

' 依赖关系注释
note right of MainWindow
  主窗口作为协调者：

- 管理页面导航
- 处理网络事件
- 加载配置信息
  end note

note right of PageManager
  页面管理器职责：

- 页面注册和切换
- 页面历史管理
- 页面生命周期管理
  end note

note right of MessageHandlerFactory
  工厂模式实现：

- 按消息类型创建处理器
- 支持动态注册新处理器
- 符合开闭原则
  end note

@enduml
